const Townhall=require("../model/townhall.model"),Account=require("../model/account.model");async function getTownhallData(l,a,o){try{Townhall.findOne({slug:l.body.slug}).exec().then((l=>{a.json({townhall:l})})).catch((l=>console.error(l)))}catch(l){console.log("api/controller/townhall.controller/getTownhallData"+l)}}async function joinTownhall(l,a,o){try{Townhall.findOneAndUpdate({_id:l.body._id},{$push:{villagers:l.body.villager}}).then((l=>{a.json({townhall:l})})).catch((l=>console.error(l)))}catch(l){console.log("api/controller/townhall.controller/joinTownhall"+l)}}async function createTownHall(l,a,o){try{let o=l.body.data;var e=[];e.push(l.body._addr);var t=l.body.data.master.replace(/[, ]+/g,"").trim();if(""!=t)t.split("\n").map((l=>{e.push(l)}));var n=l.body.data.warden.replace(/[, ]+/g,"").trim();if(""!=n)n.split("\n").map((l=>{e.push(l)}));for(var r=[],c=0;c<e.length;c++){let l=await Account.findOne({address:e[c]}).exec();l&&r.push(l._id)}let s=new Townhall({superwarden:l.body._addr,villagers:r,details:o,created_at:new Date,updated_at:new Date});await s.save().then((async l=>{a.json({data:l})}))}catch(l){console.log("api/controller/townhall.controller"+l)}}async function getProposalData(l,a,o){try{a.json({data:[]})}catch(l){console.log("api/controller/townhall.controller/getProposalData"+l)}}async function updateTownHall(l,a,o){try{let o=l.body.data;var e=[];e.push(l.body.superwarden);var t=l.body.data.master.replace(/[, ]+/g,"").trim();if(""!=t)t.split("\n").map((l=>{e.push(l)}));var n=l.body.data.warden.replace(/[, ]+/g,"").trim();if(""!=n)n.split("\n").map((l=>{e.push(l)}));for(var r=[],c=0;c<e.length;c++){let l=await Account.findOne({address:e[c]}).exec();l&&r.push(l._id)}console.log(l.body.slug),Townhall.findOneAndUpdate({"details.slug":l.body.slug},{villagers:r,details:o,updated_at:new Date}).then((l=>{a.json({data:l})}))}catch(l){console.log("api/controller/townhall.controller/updateTownHall"+l)}}async function getMyTownhall(l,a,o){try{Townhall.findOne({superwarden:l.body._addr}).then((l=>{a.json({data:l})}))}catch(l){console.log("api/controller/townhall.controller"+l)}}async function getTownhallList(l,a,o){try{let o={};l.body.search.name&&(o["details.name"]=new RegExp(l.body.search.name,"i")),l.body.search.type&&"all"!=l.body.search.type&&(o["details.categories"]=l.body.search.type),Townhall.find(o).populate({path:"villagers"}).then((l=>{a.json({data:l})}))}catch(l){console.log("api/controller/townhall.controller"+l)}}async function checkSlugName(l,a,o){try{console.log("pppppppppppppppp"),Townhall.count({"details.slug":l.body.slug}).exec().then((l=>{console.log(l),a.json({count:l})}))}catch(l){console.log("api/controller/townhall.controller"+l)}}module.exports={createTownHall:createTownHall,getMyTownhall:getMyTownhall,getTownhallList:getTownhallList,getProposalData:getProposalData,updateTownHall:updateTownHall,getTownhallData:getTownhallData,joinTownhall:joinTownhall,checkSlugName:checkSlugName};